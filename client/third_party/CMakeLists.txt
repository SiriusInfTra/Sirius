cmake_minimum_required(VERSION 3.20)
project(sirius-client LANGUAGES CXX C CUDA)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_C_STANDARD 11)
find_package(CUDAToolkit 11 REQUIRED)
if(NOT DEFINED CMAKE_CUDA_ARCHITECTURES)
  set(CMAKE_CUDA_ARCHITECTURES 70)
endif()


set(TRITON_SOURCE_DIR ${PROJECT_SOURCE_DIR}/triton-client)
set(TRITON_INSTALL_DIR ${CMAKE_BINARY_DIR}/triton/install)
execute_process(
    COMMAND git rev-parse --abbrev-ref HEAD
    WORKING_DIRECTORY ${TRITON_SOURCE_DIR}
    OUTPUT_VARIABLE TRITON_BRANCH_NAME
    OUTPUT_STRIP_TRAILING_WHITESPACE
)

message(STATUS "Triton Branch Name: ${TRITON_BRANCH_NAME}")

include(ExternalProject)
ExternalProject_Add(triton-client
    SOURCE_DIR ${TRITON_SOURCE_DIR}
    CMAKE_ARGS 
        -DTRITON_ENABLE_CC_HTTP=OFF 
        -DTRITON_ENABLE_CC_GRPC=ON 
        -DTRITON_ENABLE_PERF_ANALYZER=OFF
        -DTRITON_ENABLE_PERF_ANALYZER_C_API=OFF 
        -DTRITON_ENABLE_PERF_ANALYZER_TFS=OFF
        -DTRITON_ENABLE_PERF_ANALYZER_TS=OFF
        -DTRITON_ENABLE_GPU=ON 
        -DTRITON_ENABLE_EXAMPLES=OFF 
        -DTRITON_ENABLE_TESTS=OFF
        -DTRITON_KEEP_TYPEINFO=ON
        -DTRITON_COMMON_REPO_TAG=${TRITON_BRANCH_NAME}
        -DTRITON_THIRD_PARTY_REPO_TAG=${TRITON_BRANCH_NAME}
        -DTRITON_CORE_REPO_TAG=${TRITON_BRANCH_NAME}
    INSTALL_COMMAND ""
)